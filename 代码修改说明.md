# 代码修改说明

## 修改概述

根据需求，本次修改主要完成了两个任务：

### 1. MCP初始化优化
将MCP工具和子Agent的初始化从流程开始时移到项目启动时，提高效率并避免重复初始化。

### 2. 工具执行数据存储
实现了按任务类型（transport、hotel、weather等）分类存储工具执行信息到JSON文件的功能，方便后续RAG检索和数据分析。

---

## 详细修改内容

### 1. 新增文件

#### `backend/utils/mcp_manager.py`
- **功能**: MCP管理器，使用单例模式管理MCP工具和子Agent的全局初始化
- **主要类**: `MCPManager`
  - `initialize()`: 在项目启动时初始化MCP工具和子Agent
  - `get_tools_by_server()`: 获取MCP工具字典
  - `get_sub_agents()`: 获取子Agent字典
  - `is_initialized()`: 检查是否已初始化
- **全局函数**:
  - `initialize_mcp_manager()`: 初始化全局MCP管理器
  - `get_mcp_manager()`: 获取全局MCP管理器实例

#### `backend/utils/tool_data_storage.py`
- **功能**: 工具执行数据存储模块，按类型分类存储到JSON文件
- **主要类**: `ToolDataStorage`
  - `save_tool_execution()`: 保存单个工具执行记录
  - `save_batch_executions()`: 批量保存工具执行记录
  - `query_by_category()`: 按类别查询记录
  - `query_by_context()`: 根据上下文查询记录
  - `get_statistics()`: 获取存储统计信息
- **存储格式**:
  ```json
  {
    "timestamp": "2025-12-18T10:30:00",
    "category": "transport",
    "tool_name": "search_train",
    "tool_input": {"from": "郑州", "to": "北京"},
    "tool_output": "查询结果...",
    "context": {"origin": "郑州", "destination": "北京", "date": "2025-09-22"},
    "metadata": {"task": "查询火车票", "agent_name": "交通助手", "round": 1}
  }
  ```
- **存储位置**: `data/tool_executions/{category}.json`
  - `transport.json`: 交通类工具执行记录
  - `hotel.json`: 酒店类工具执行记录
  - `weather.json`: 天气类工具执行记录
  - `map.json`: 地图类工具执行记录
  - 等等

#### `backend/test_tool_storage.py`
- **功能**: 工具数据存储测试和使用示例
- **演示内容**:
  - 查看存储统计信息
  - 按类别查询记录
  - 根据上下文过滤查询
  - 展示数据格式

---

### 2. 修改的文件

#### `backend/app.py`
**修改内容**:
- 添加了 `lifespan` 上下文管理器（替代已弃用的 `@app.on_event("startup")`）
- 在应用启动时调用 `initialize_mcp_manager()` 初始化MCP工具和子Agent
- 添加了日志输出，显示初始化进度

**关键代码**:
```python
@asynccontextmanager
async def lifespan(_app: FastAPI):
    # 启动时初始化MCP
    logger.info("正在初始化MCP工具和子Agent...")
    success = await initialize_mcp_manager(timeout=30)

    if success:
        logger.info("✅ MCP初始化成功")
    else:
        logger.warning("⚠️ MCP初始化失败，系统将在无MCP工具的情况下运行")

    yield  # 应用运行期间

    # 关闭时清理资源
    logger.info("应用关闭中...")

app = FastAPI(title="旅游助手", lifespan=lifespan)
```

#### `backend/agent/amusement_agent.py`
**修改内容**:
1. 移除了 `get_mcp_trival_tools()` 函数和 `_mcp_trival_tools` 全局变量
2. 导入 `get_mcp_manager` 替代 `get_mcp_tools`
3. 在 `excute()` 函数中，从全局MCP管理器获取工具和子Agent，而不是每次都初始化
4. 修改 `_execute_single_task()` 函数签名，添加 `category` 参数并传递给子Agent

**关键代码**:
```python
# 从全局MCP管理器获取工具和子Agent
mcp_manager = get_mcp_manager()

if not mcp_manager.is_initialized():
    logger.error("MCP管理器未初始化，无法执行任务")
    return {"messages": [AIMessage(content="系统错误：MCP管理器未初始化")]}

tools_by_server = mcp_manager.get_tools_by_server()
sub_agents = mcp_manager.get_sub_agents()
```

#### `backend/agent/sub_agents.py`
**修改内容**:
1. 导入 `get_tool_storage` 工具数据存储模块
2. 在 `execute_task()` 方法中添加 `category` 参数
3. 在每次工具执行后，自动保存工具执行记录到JSON文件
4. 保存位置：主循环工具执行（第157行）、额外轮次工具执行（第222行）

**关键代码**:
```python
# 保存工具执行结果到JSON文件
for tool_msg in tool_messages:
    try:
        tool_name = tool_msg.name if hasattr(tool_msg, 'name') else 'unknown'
        # 解析工具输入
        tool_input = {}
        if hasattr(response, 'tool_calls'):
            for tool_call in response.tool_calls:
                if tool_call.get('id') == tool_msg.tool_call_id:
                    tool_input = tool_call.get('args', {})
                    break

        storage.save_tool_execution(
            category=category,
            tool_name=tool_name,
            tool_input=tool_input,
            tool_output=tool_msg.content,
            context=context,
            metadata={
                "task": task,
                "agent_name": self.name,
                "round": round_num
            }
        )
    except Exception as e:
        logger.error(f"保存工具执行结果失败: {e}")
```

---

## 使用指南

### 启动应用
启动应用时，MCP工具和子Agent会自动初始化：

```bash
cd backend
python app.py
```

**预期日志输出**:
```
================================================================================
【应用启动】开始初始化...
================================================================================
正在初始化MCP工具和子Agent...
================================================================================
【MCP管理器】开始初始化MCP工具和子Agent...
================================================================================
【步骤1/2】正在连接MCP服务器并获取工具...
✅ MCP工具获取成功：共 XX 个工具，来自 X 个服务器
  - amap-maps: X 个工具
  - 12306-mcp: X 个工具
  - flight-ticket-mcp: X 个工具
  - mcp_tool: X 个工具
【步骤2/2】正在创建子Agent...
✅ 子Agent创建成功：共 X 个子Agent
  - transport: 交通助手 (负责查询火车票、机票等交通信息)
  - weather: 天气助手 (查询天气信息)
  - hotel: 酒店助手 (查询和推荐酒店)
  - map: 地图助手 (POI搜索和路线规划)
  - search: 搜索助手 (通用信息搜索)
================================================================================
【MCP管理器】初始化完成！
================================================================================
✅ MCP初始化成功
================================================================================
【应用启动】初始化完成，服务已就绪
================================================================================
```

### 查看存储的工具执行数据

#### 方法1: 直接查看JSON文件
工具执行数据存储在 `backend/data/tool_executions/` 目录下：
```
data/tool_executions/
├── transport.json    # 交通查询记录
├── hotel.json        # 酒店查询记录
├── weather.json      # 天气查询记录
├── map.json          # 地图查询记录
└── search.json       # 搜索查询记录
```

#### 方法2: 使用测试脚本
运行测试脚本查看统计信息和数据：
```bash
cd backend
python test_tool_storage.py
```

#### 方法3: 在代码中使用
```python
from utils.tool_data_storage import get_tool_storage

# 获取存储实例
storage = get_tool_storage()

# 查询transport类别的最新10条记录
records = storage.query_by_category("transport", limit=10)

# 查询特定目的地的记录
beijing_records = storage.query_by_context(
    category="transport",
    context_filters={"destination": "北京"}
)

# 获取统计信息
stats = storage.get_statistics()
print(f"总记录数: {stats['total_records']}")
```

---

## 优势和改进

### 1. MCP初始化优化的优势
- ✅ **性能提升**: 只在项目启动时初始化一次，避免每次流程都重新连接MCP服务器
- ✅ **资源节省**: 减少重复的网络连接和资源消耗
- ✅ **启动更快**: 流程启动时不需要等待MCP初始化
- ✅ **更好的错误处理**: 启动时就能发现MCP连接问题，而不是运行时才报错

### 2. 工具执行数据存储的优势
- ✅ **数据可追溯**: 所有工具执行记录都被保存，方便审计和分析
- ✅ **分类存储**: 按任务类型分类，便于后续RAG检索
- ✅ **结构化数据**: JSON格式存储，包含完整的上下文信息
- ✅ **灵活查询**: 支持按类别、上下文、工具名称等多种方式查询
- ✅ **RAG准备**: 为后续实现RAG功能提供了高质量的数据源

### 3. 代码改进
- ✅ **单例模式**: MCP管理器使用单例模式，确保全局只有一个实例
- ✅ **解耦**: 工具数据存储模块独立，不影响现有业务逻辑
- ✅ **错误处理**: 完善的异常捕获和日志记录
- ✅ **可扩展**: 易于添加新的存储类别和查询功能

---

## 后续RAG集成建议

基于当前的工具执行数据存储，后续可以轻松实现RAG功能：

### 1. 向量化存储
```python
from langchain.embeddings import OpenAIEmbeddings
from langchain.vectorstores import FAISS

# 读取工具执行记录
storage = get_tool_storage()
records = storage.query_by_category("transport")

# 构建文档
docs = [
    f"任务: {r['metadata']['task']}\n输入: {r['tool_input']}\n输出: {r['tool_output']}"
    for r in records
]

# 向量化并存储
embeddings = OpenAIEmbeddings()
vectorstore = FAISS.from_texts(docs, embeddings)
```

### 2. 检索增强
```python
# 检索相关历史记录
query = "查询北京到上海的火车票"
relevant_docs = vectorstore.similarity_search(query, k=5)

# 将相关记录作为上下文传递给LLM
context = "\n".join([doc.page_content for doc in relevant_docs])
prompt = f"参考历史记录：\n{context}\n\n当前任务：{query}"
```

### 3. 智能缓存
利用历史记录避免重复查询：
```python
# 检查是否有相同查询的缓存
similar_records = storage.query_by_context(
    category="transport",
    context_filters={"origin": "北京", "destination": "上海", "date": "2025-09-22"}
)

if similar_records:
    # 使用缓存结果
    cached_result = similar_records[-1]['tool_output']
else:
    # 执行新查询
    result = await execute_tool(...)
```

---

## 注意事项

1. **数据目录**: 首次运行时会自动创建 `data/tool_executions/` 目录
2. **文件大小**: JSON文件会随着使用不断增长，建议定期归档或清理旧数据
3. **隐私保护**: 工具执行记录可能包含敏感信息，注意数据安全
4. **并发写入**: 当前实现为简单文件写入，高并发场景可能需要优化（如使用数据库）

---

## 总结

本次修改成功实现了：
1. ✅ 将MCP初始化从流程开始时移到项目启动时
2. ✅ 创建了完善的工具执行数据存储系统
3. ✅ 按任务类型分类存储，便于后续RAG应用
4. ✅ 提供了查询和统计接口
5. ✅ 保持了代码的可维护性和可扩展性

所有修改都经过了详细的日志记录和错误处理，不会影响现有功能的正常运行。
