# 人工介入功能使用说明

## 功能概述

本旅游规划系统支持**智能人工介入**功能，允许大模型在规划过程中主动请求用户提供额外信息或做出选择，然后**流程自动恢复并继续执行**。

### 核心特性

✅ **LLM自主判断**：大模型根据实际情况决定是否需要人工介入，而不是硬编码规则
✅ **真正的暂停和恢复**：流程暂停等待用户响应，用户提交后从暂停位置继续执行
✅ **支持多种交互方式**：文本输入、单选、多选
✅ **支持多轮介入**：一个流程中可以多次请求人工介入

---

## 工作流程

```
用户提交旅游规划请求
    ↓
1. plan阶段：LLM生成初步规划
    ↓
   LLM判断：需要人工介入？
    ↓               ↓
   否              是
    ↓               ↓
2. excute        暂停，返回问题给用户
    ↓               ↓
3. replan        用户提交响应
    ↓               ↓
   LLM判断：需要人工介入？  流程恢复，重新执行plan
    ↓               ↓        ↓
   否              是      继续正常流程...
    ↓               ↓
4. observation   暂停，返回问题给用户
    ↓               ↓
   完成          用户提交响应
                   ↓
                流程恢复，重新执行replan
                   ↓
                继续正常流程...
```

---

## API接口

### 1. 开始旅游规划

**端点**: `POST /travel`

**请求体**:
```json
{
  "origin": "郑州",
  "destination": "北京",
  "date": "2025-12-01",
  "people": 2,
  "budget": 5000,
  "preferences": "美食、文化",
  "days": 3
}
```

**响应（需要人工介入）**:
```json
{
  "session_id": "uuid-xxx",
  "status": "need_intervention",
  "need_intervention": true,
  "intervention_request": {
    "stage": "plan",
    "message": "我为您规划了三条不同风格的旅游路线，请选择您更感兴趣的一条",
    "question_type": "single_choice",
    "options": [
      {"id": "cultural", "text": "文化历史路线：故宫 → 颐和园 → 长城"},
      {"id": "modern", "text": "现代都市路线：三里屯 → 798艺术区 → 国贸"},
      {"id": "nature", "text": "自然风光路线：香山 → 植物园 → 奥林匹克森林公园"}
    ],
    "current_plan": ["查询北京天气", "搜索旅游路线", "查找周边信息"]
  }
}
```

**响应（已完成）**:
```json
{
  "session_id": "uuid-xxx",
  "status": "completed",
  "need_intervention": false,
  "plan": ["查询天气", "规划路线"],
  "replan": ["优化后的规划1", "优化后的规划2"],
  "amusement_info": {
    "around": [...],
    "path": {...},
    "weather": {...}
  }
}
```

### 2. 恢复暂停的流程

**端点**: `POST /resume`

**请求体（文本输入）**:
```json
{
  "session_id": "uuid-xxx",
  "text_input": "我更喜欢文化历史类的景点",
  "selected_options": null
}
```

**请求体（单选）**:
```json
{
  "session_id": "uuid-xxx",
  "text_input": null,
  "selected_options": ["cultural"]
}
```

**请求体（多选）**:
```json
{
  "session_id": "uuid-xxx",
  "text_input": null,
  "selected_options": ["cultural", "nature"]
}
```

**响应**: 与`/travel`相同，可能再次需要人工介入或直接返回完成结果

---

## LLM如何请求人工介入

大模型在plan或replan阶段，按照以下格式输出即可请求人工介入：

### 场景1：多个选项让用户选择

```json
{
  "plan": ["规划步骤1", "规划步骤2"],
  "need_intervention": true,
  "intervention_request": {
    "stage": "plan",
    "message": "我为您找到3个酒店选项，请选择您偏好的档次",
    "question_type": "single_choice",
    "options": [
      {"id": "luxury", "text": "五星级酒店（600元/晚）"},
      {"id": "mid", "text": "四星级酒店（300元/晚）"},
      {"id": "budget", "text": "经济型酒店（150元/晚）"}
    ],
    "current_plan": ["查询酒店", "规划路线"]
  }
}
```

### 场景2：需要用户补充信息

```json
{
  "plan": ["查询天气", "规划路线"],
  "need_intervention": true,
  "intervention_request": {
    "stage": "plan",
    "message": "您计划前往西藏，请告诉我您是否有高原反应病史，以便为您制定合适的行程",
    "question_type": "text",
    "options": null,
    "current_plan": ["查询天气", "规划高原行程"]
  }
}
```

### 场景3：预算调整确认

```json
{
  "replan": ["调整后的规划1", "调整后的规划2"],
  "amusement_info": {...},
  "need_intervention": true,
  "intervention_request": {
    "stage": "replan",
    "message": "根据您的需求，推荐行程预算约为8000元，超出了您的预算(5000元)。是否需要调整？",
    "question_type": "single_choice",
    "options": [
      {"id": "increase", "text": "我可以增加预算到8000元"},
      {"id": "adjust", "text": "请帮我调整到5000元以内"}
    ],
    "current_plan": ["已查询景点", "已规划路线"]
  }
}
```

---

## 前端实现示例

```javascript
// 提交旅游规划请求
const data = await generateTravelPlan({
  origin: "郑州",
  destination: "北京",
  date: "2025-12-01",
  people: 2,
  budget: 5000,
  preferences: "美食、文化",
  days: 3
});

if (data.need_intervention) {
  // 需要人工介入，显示问题和选项
  showInterventionUI(data.intervention_request);

  // 用户提交响应后
  const response = await resumeTravelPlan(data.session_id, {
    text_input: userInput || null,
    selected_options: selectedOptions || null
  });

  // 检查是否再次需要人工介入
  if (response.need_intervention) {
    showInterventionUI(response.intervention_request);
  } else {
    // 完成，显示结果
    showResult(response);
  }
} else {
  // 直接完成，显示结果
  showResult(data);
}
```

---

## 技术实现细节

### 工作流图

```
START → resume_router
  ↓
  判断：是首次执行还是恢复？
  ↓                    ↓
首次/循环           从plan恢复  从replan恢复
  ↓                    ↓            ↓
plan → check → wait_plan_END  observation → ...
  ↓            ↓
不需要介入   需要介入
  ↓            ↓
excute       wait_user → END
  ↓
replan → check → wait_replan_END
  ↓            ↓
不需要介入   需要介入
  ↓            ↓
observation  wait_user → END
```

### 关键状态字段

- `need_intervention`: 是否需要人工介入
- `intervention_stage`: 介入阶段（"plan"或"replan"）
- `intervention_request`: LLM的介入请求详情
- `intervention_response`: 用户的响应

### 恢复机制

1. **暂停**: 当LLM设置`need_intervention=true`时，流程到达`wait_user`节点，然后END
2. **保存**: API将完整的state保存到session_store
3. **用户响应**: 用户通过`/resume`提交响应
4. **更新state**: API更新`intervention_response`字段
5. **恢复执行**: 调用`graph.ainvoke(state)`重新执行
6. **智能路由**: `resume_router`根据`intervention_stage`决定从plan或replan继续
7. **处理响应**: plan/replan函数读取`intervention_response`并将其融入规划
8. **继续流程**: 流程从暂停位置自然继续执行

---

## 示例对话流程

**用户**: 我想去北京旅游，预算5000元

**系统**: [执行plan] → LLM生成规划 → 判断需要人工介入

**返回给用户**:
```
我为您规划了两种出行方式：
1. 高铁（快速舒适，往返约800元）
2. 飞机（更快捷，往返约1200元）
请选择您偏好的交通方式
```

**用户**: 选择高铁

**系统**: [恢复执行] → plan处理用户选择 → 继续到excute → replan → 判断需要人工介入

**返回给用户**:
```
根据您的预算，我为您找到了3个住宿选项：
1. 四星级酒店（距离景点近，300元/晚）
2. 三星级酒店（性价比高，180元/晚）
3. 青年旅社（经济实惠，80元/晚）
请选择您的住宿偏好
```

**用户**: 选择三星级酒店

**系统**: [恢复执行] → replan处理用户选择 → observation → 完成

**返回给用户**:
```
✅ 旅游规划已完成！

出行方式: 高铁
住宿: 三星级酒店
行程:
Day 1: 故宫 → 王府井
Day 2: 长城 → 鸟巢
Day 3: 颐和园 → 返程

预算明细: 交通800 + 住宿540 + 门票300 + 餐饮1000 = 2640元（剩余2360元）
```

---

## 注意事项

1. **会话管理**: 当前使用内存存储session_store，生产环境应使用Redis或数据库
2. **会话过期**: 建议设置会话过期时间，避免内存泄漏
3. **错误处理**: 如果用户长时间未响应，应清理过期会话
4. **幂等性**: resume操作应该是幂等的，多次调用不会产生副作用

---

## 自定义人工介入逻辑

如果您想修改LLM判断人工介入的条件，请编辑以下文件：

- **Prompt配置**: `backend/prompts/amusement_prompt.py`
  - 修改`SYSTEM_PLAN_TEMPLATE`的"人工介入机制"部分
  - 修改`SYSYRM_REPLAN_TEMPLATE`的"人工介入机制"部分

- **数据格式**: `backend/formatters/amusement_format.py`
  - `InterventionRequest`: 介入请求的数据结构
  - `PlanWithIntervention`/`ReplanWithIntervention`: 输出格式

系统完全由LLM驱动，您可以通过修改Prompt来调整LLM的判断策略，无需修改代码逻辑！
