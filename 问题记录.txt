1、asked_questions是干啥的：人工介入时，向人问的问题
2、langchain版本变动，导致工具调用出问题了：在amusement_agent.py文件里272行这里的ai_message，发现一个问题。此时ai_message的内容是AIMessage(content='', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 353, 'prompt_tokens': 3012, 'total_tokens': 3365, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_provider': 'openai', 'model_name': 'gpt-5-mini', 'system_fingerprint': None, 'id': 'chatcmpl-CdzFbOFXcyXl962pSdH2HzmrNJEup', 'finish_reason': 'tool_calls', 'logprobs': None}, id='lc_run--101b6d82-89cd-4603-a1eb-216de2f51c8e-0', tool_calls=[{'name': 'get-station-code-of-citys', 'args': {'citys': '沈阳|长沙'}, 'id': 'call_LCaTJkPsTxBsEoMYzotRb5Cp', 'type': 'tool_call'}], usage_metadata={'input_tokens': 3012, 'output_tokens': 353, 'total_tokens': 3365, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 320}})   我发现additional_kwargs里没有写关于工具调用的内容，但是ai_message却出现了关于工具调用的内容，例如tool_calls=[{'name': 'get-station-code-of-citys', 'args': {'citys': '沈阳|长沙'}, 是不是因为最近langchain有比较大的更新的缘故还是怎么回事？
问题分析
你说得对，这确实是 LangChain 最近版本更新 导致的结构变化：
旧版本 LangChain
工具调用信息在 ai_message.additional_kwargs['tool_calls'] 中
新版本 LangChain
工具调用信息被提升为 一级属性 ai_message.tool_calls
additional_kwargs 中不再包含 tool_calls
3、漏掉了一个消息，具体玩几天：解决了
4、最后应该检查规划是否完成：解决了
5、最后返回的内容不对:解决了

6、我觉得plan之后，并不是每条规划都需要去执行execute。因为就比如你在日志中规划出来的前两条(727、728行)计划是一个总体的，然后后面的规划实际上就是对前面
两条的具体规划，那我觉得你前两条规划就没必要去执行execute了。不然execute的模型可能觉得你还没规划，又给你返回一些你在plan阶段规划好的内容。
然后你在下面几条又分开说要查询什么信息，执行什么工具。这挺好，所以我觉得你这要这样的规划给execute模型，才能更好的去在execute阶段去执行工具。
但是我觉得也不要把所有的需要执行工具的消息一次性给execute,因为这样模型可能就会甚至漏掉很多工具的调用。
总体来说我觉得你已经在plan阶段把需要执行工具的plan单独分点列出来了，那就只需要把这些需要执行工具的plan单独给execute的模型去调用工具就好了，
与此同时我觉得每当运行到execute节点时，应该把需要调用工具的消息都执行完再重新统一去replan，而不是每执行一条就去replan一次,这样会很乱。
7、感觉得把给模型的输入信息也记录到日志，方便我进行优化


这是最新的运行日志travel_20251124_132446_1ad36b57.log，
1、640行在执行第一个任务时，先调用了get-station-code-of-citys，这没问题，
因为调用get-tickets之前好像确实需要先获取站点的code。但是为啥就没有后续了呢？是不是因为此时工具并没有执行，需要等到use_tools节点去执行，
就导致貌似想完成调用get-tickets任务，但是实际调用了获得站点code的工具，导致get-tickets没完成。
2、而且调用工具时，是使用的内置的工具节点，
我连工具调用的返回内容都看不到。能不能不用内置的工具调用节点，你帮我实现一个，这样的话，每次调用工具时，我都能查看调用流程代码，以及工具调用返回内容。
3、再回到第一个问题，我觉得是不是不能把所有工具调用在execute处理完了，再去user_tools统一执行工具。因为就像刚刚1这种情况，可能就不好解决。
最好是在execute的for idx, task in enumerate(pending_tasks, 1): 循环里，每执行一次，如果返回了工具调用，那么直接去调用工具，可能调用一次工具没完成，
就例如刚刚对于get-tickets这种情况，需要多次调用的，那就继续执行，再调用下一个工具，直到当前规划的任务完成，再去处理下一条规划，进入下一次循环。
如果多次处理都没完成，那可能就出了意外情况，才能跳过去 4、我有一个单独存放prompt的文件，不要直接在流程里写prompt。



1、前端可视化问题，最后的详细攻略应该有一个更好的可视化方式，不然看起来太乱了。而且返回给用户的信息应该是总结处理过之后的，不能是这种结构化的原始数据，这种结构化的原始
数据，可以保存在日志，但是不能直接返回给用户。
2、每一个任务的多轮工具调用结束之后，应该对该轮任务的进行工具调用后所得到的信息进行处理，最基本的重复数据去重、与规划内容无关的垃圾信息过滤操作。
4、plan阶段prompt的有些工具可能根本没有，我觉得plan阶段prompt就不要提及具体工具名称，因为prompt给的名称啥的都不对，反而可能误导execute阶段调用工具。
5、什么我说在plan阶段不要写具体工具呢，就比如get-tickets明明是查询火车票的工具。但是在execute却用来查机票了。最后没查到，又使用tavily_search工具去网上搜了，
查了一堆垃圾信息。而且之前也提到过，机票、火车票这类信息一定是要调用mcp对应的工具的，不然信息可能会不准确
6、同时需要把response = await retry_llm_call的response  记录到日志，我需要看看一次性返回了都需要调用哪些工具。
7、判断工具调用任务完成这一块有点bug，如果最后一轮得到了完整的所需消息，那么任务就完成了。但是509行就直接break了，task_completed此时还是false，把任务当作没完成。
8、日志里显示执行最后一个任务时：“基于上述票价（航班/车次）、酒店报价与每日餐饮/景点门票估算，计算初步预算清单并与用户总预算5000元进行匹配（此任务需在获取票价与酒店价格后由系统计算汇总）”时，模型由于看不到我之前执行工具得到的车票，酒店等内容，然后又去重新查询车票、酒店等信息了，所以这种最后总结类的规划是不是也应该单独放置并处理或者怎么有什么更好的处理方法。因为这是需要根据我之前调用工具所得信息以及我的规划等信息去联合总结，而不需要再去使用工具。就算发现信息不完整，也是在下一轮replan去补充了。
9、当整个流程执行完，在observation阶段，会判断是否规划完成。如果判断没规划完成，应该给出分点的未完成的原因，例如1：缺少酒店预订信息等等，2、缺少用户指定的某某信息。那么在下一轮规划时，应该基于上一轮所得到的有用信息以及observation给出的原因继续规划，而不是直接从0开始规划。


11、五轮强制结束有点问题
14、酒店价格、订房信息查不到
16、我是不是可以增加一个类似于rag的方法，因为调用工具检索到的内容太多了。
在第三轮调用天气工具时，貌似重复调用了好几次maps_weather工具，而且重复调用了好几轮，
我看最后不是返回了"city": "长沙市",
  "forecasts": [
    {
      "date": "2025-11-24",
      "week": "1",
      "dayweather": "多云",
      "nightweather": "多云",
      "daytemp": "20",
      "nighttemp": "6",
      "daywind": "北",
      "nightwind": "北",
      "daypower": "1-3",
      "nightpower": "1-3",
      "daytemp_float": "20.0",
      "nighttemp_float": "6.0"
    },
    {
      "date": "2025-11-25",
      "week": "2",
      "dayweather": "晴",
      "nightweather": "晴",
      "daytemp": "16", 这些信息吗？为什么还会多轮调用呢？
17、使用langgraph-cli追踪，但是python>=3.11